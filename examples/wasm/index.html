<html>
  <head>
    <script src="stream_file.js"></script>
    <script src="zsv.js"></script>
    <script>
      let zHandle;
      let rowcount;
      let start;
      let data;
      let bytes_read;

      function reset() {
        rowcount = 0;
        start = performance.now();
        data = [];
        bytes_read = 0;
      }

      function row_handler() {
        rowcount++;
        let count = zsv_parser.cell_count(zHandle);
        let row = [];
        for(let i = 0; i < count; i++)
          row.push(zsv_parser.get_cell(zHandle, i));
        data.push(row);
      }

      function display_result() {
        let end = performance.now()
        alert('Parsed ' + bytes_read + ' bytes; ' + rowcount + ' rows in ' + (end - start) + 'ms\n' +
              'You can view the parsed data in your browser dev tools console (rt-click and select Inspect)');
        console.log('zsv parsed data', data);
      }

      function parseFile(e) {
        if(e.target.files && e.target.files.length) {
          let file = e.target.files[0];
          reset();
          zHandle = zsv_parser.new(row_handler);
          let finish = function() {
            zsv_parser.finish(zHandle);
            display_result();
            zsv_parser.delete(zHandle);
            reset();
          };
          stream_file(file, 4096, function(err, data) {
            if(!err) {
              if(data) {
                bytes_read += data.length;
                zsv_parser.parse_bytes(zHandle, data);
              } else // all done
                finish();
            } else {
              console.error('Error!', err);
              // cleanup
              finish();
            }
          });
        }
      }

      window.addEventListener('load', function() {
        let file_input = document.body.querySelector('#file_input');
        file_input.addEventListener('change', parseFile);
      })
    </script>
  </head>
  <body>
  <input id="file_input" type="file" accept=".csv" oninput="parseFile">
  </body>
</html>
