name: codeql

on: workflow_dispatch

jobs:
  codeql:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: [actions, c]

    permissions:
      security-events: write

    steps:
    - name: Checkout [${{ github.repository }}]
      uses: actions/checkout@v5

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{  matrix.language == 'c' && 'manual' || 'none' }}

    - name: Build
      if: ${{ matrix.language == 'c' }}
      env:
        PREFIX: amd64-linux-gcc
        CC: gcc
        MAKE: make
        ARTIFACT_DIR: .artifacts
        RUN_TESTS: true
        SKIP_ZIP_ARCHIVE: true
        SKIP_TAR_ARCHIVE: true
      run: ./scripts/ci-build.sh

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
