<!DOCTYPE html>
<html lang="en-us" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>zsv playground __VERSION__</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css" />

  <script type="text/javascript">
    var Module = {
      print: (function () {
        return (...args) => {
          const output = args.join(' ');
          $('#terminal').terminal().echo(output);
        };
      })(),
      printErr: (function () {
        return (...args) => {
          const output = args.join(' ');
          $('#terminal').terminal().error(output);
        };
      })()
    };

    Module['onRuntimeInitialized'] = function () {
      const root = '/home/zsv';
      FS.mkdir(root);
      FS.chdir(root);
      // FS.writeFile('test.csv', 'a,b,c\n1,2,3\n4,5,6\n7,8,9');
    }

    function clearStdin() {
      document.getElementById('stdin').value = '';
    }

    function getFiles() {
      const listing = FS.readdir('.');
      const filtered = listing.filter((entry) => (entry !== '.' && entry !== '..'));
      return filtered.join('\n');
    }

    async function addFile(event) {
      const file = event.target.files.item(0);
      const filename = file.name;
      const reader = new FileReader();
      reader.addEventListener('loadend', () => {
        const bytes = new Uint8Array(reader.result);
        FS.writeFile(filename, bytes);
      });
      reader.readAsArrayBuffer(file);
      document.getElementById('files').innerText += `${filename}\n`;
    }
  </script>
</head>

<body class="p-0 mt-0 font-monospace">
  <div id="container">
    <div class="text-center text-bg-primary fs-4">
      <a href="https://github.com/liquidaty/zsv" class="text-bg-primary">zsv</a> playground __VERSION__
    </div>

    <div class="row flex-nowrap g-0">
      <div class="col-9 p-3">
        <label for="stdin" class="form-label">stdin (csv)</label>
        <span>
          <button id="clear" class="btn btn-outline-secondary btn-sm" type="button"
            style="width: auto; padding: 0px 5px 0px 5px; float: right;" onclick="clearStdin();">clear</button>
        </span>
        <textarea id="stdin" class="form-control"
          style="border-radius: 0px; height: 300px; max-height: 300px; resize: none; white-space: nowrap;"></textarea>
      </div>

      <div class="col-3 p-3">
        <label for="files" class="form-label">files</label>
        <span>
          <label for="add" class="btn btn-outline-secondary btn-sm"
            style="width: auto; padding: 0px 5px 0px 5px; float: right;">add</label>
          <input id="add" type="file" accept=".csv" style="display: none;" onchange="addFile(event);">
        </span>
        <pre id="files" class="form-control overflow-auto"
          style="height: 300px; max-height: 300px; resize: none;"></pre>
      </div>
    </div>

    <div class="row flex-nowrap g-0">
      <div class="col p-3">
        <div id="terminal" style="height: 400px; max-height: 400px; resize: both;"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    // Logo generated from:
    // https://patorjk.com/software/taag/#p=display&f=Doom&t=zsv%20playground
    // Replaced backticks with single quotes
    const logo = String.raw`
[[;red;]Welcome to     ] [[;blue;]      | |                                           | |]
[[;red;] _________   __] [[;blue;] _ __ | | __ _ _   _  __ _ _ __ ___  _   _ _ __   __| |]
[[;red;]|_  / __\ \ / /] [[;blue;]| '_ \| |/ _' | | | |/ _' | '__/ _ \| | | | '_ \ / _' |]
[[;red;] / /\__ \\ V / ] [[;blue;]| |_) | | (_| | |_| | (_| | | | (_) | |_| | | | | (_| |]
[[;red;]/___|___/ \_/  ] [[;blue;]| .__/|_|\__,_|\__, |\__, |_|  \___/ \__,_|_| |_|\__,_|]
[[;blue;]                | |             __/ | __/ |]                            
[[;blue;]                |_|            |___/ |___/ ]                         :-)
`;
    const greetings = logo +
      "\n" +
      "Version: __VERSION__\n" +
      "GitHub repository: https://github.com/liquidaty/zsv\n" +
      "Report any issues here: https://github.com/liquidaty/zsv/issues\n" +
      "\n" +
      "To get started, run [[;blue;]zsv help].\n" +
      "To list all supported commands, run [[;blue;]help].\n"
      ;

    function help() {
      var help = "[[;red;]zsv playground help]";
      const commands = {
        zsv: 'run zsv CLI app',
        clear: 'clear the screen',
        ls: 'list current directory'
      };
      for (const key in commands) {
        help += `\n- [[;blue;]${key}] : ${commands[key]}`;
      }
      $('#terminal').terminal().echo(help);
    }

    function ls() {
      const files = getFiles();
      if (files.length !== 0) {
        $('#terminal').terminal().echo(files);
      }
    }

    $('#terminal').terminal(function (command) {
      const parsed_command = $.terminal.parse_command(command);
      const name = parsed_command.name;
      const args = parsed_command.args.map(String);
      switch (name) {
        case 'help':
          help();
          break;

        case 'zsv':
          Module.callMain(args);
          break;

        case 'ls':
          ls();
          break;

        default:
          this.error(`Unsupported command! [${name}]`);
          break;
      }
    }, {
      checkArity: false,
      greetings: greetings,
      prompt: "[[;lightgreen;]zsv@playground$ ]"
    });
  </script>

  <script async type="text/javascript" src="cli.em.js"></script>
</body>

</html>
